# Метеостанция с системой визуализации показаний и системой управления устройствами

Схема взаимодействий компонентов системы представлена на рисунке ниже.

![communication_scheme](https://github.com/jacobin-thx/weather_station_stm/blob/assets/communication_scheme.png)
_Рисунок 1 - Схема взаимодействий компонентов системы_

## STM32
STM32 является сердцем всей системы, контроллер собирает показания температуры, влажности и давления с датчика BME280 и принимает решение по управлению нагревателем и увлажнителем воздуха.

Также STM32 отправляет показания датчиков через ESP32 на MQTT брокер.

## Устройства 

Нагреватель и увлажнитель воздуха имеют несколько режимов работы. Они могут быть постоянно выключены, либо включены или могут находится в режиме автоматического управления, при котором решение о включении/выключении принимается исходя из последнего измерения температуры или влажности и его требуемого значения.

Для смены режима работы устройства имеются кнопки. Короткое нажатие приводит к отключению автоматического режима и смене состояния. Для включения автоматического режима необходимо продолжительное нажатие на кнопку.

Режимы работы объектов управления:
- принудительный - ОУ постоянно включен или выключен;
- автоматический - сменой состояния управляет STM32 исходя из последнего измерения и его требуемого значения.

## ESP32

ESP32 выполняет роль моста между STM32 и MQTT брокером.

ESP32 публикует показания датчиков на брокер. В обратную сторону ESP32 отправляет команды сервера по управлению нагревателем и увлажнителем.

Публикация показаний происходит только при изменении значений этих показаний. То есть одно и то же значение не будет публиковаться повторно.

Также при сбросе контроллера ESP32 запрашивает через MQTT брокер с сервера актуальную конфигурацию работы, а именно периода, по истечению которого STM32 должна отправить последние показания датчиков, и пороговые или требуемые значения температуры и влажности для автоматического управления нагревателем и увлажнителем воздуха.

## Сервер

Сервер был развернут на виртуальной машине и представляет собой базу данных для хранения показаний датчиков, систему визуализации этих показаний и панель для управления датчиками.

Для взаимодействия через сервер доступен dashboard, представленный на рисунке ниже.

![communication_scheme](https://github.com/jacobin-thx/weather_station_stm/blob/assets/dashboard.png)
_Рисунок 2 - Панели визуализации показаний и управления устройствами_

Имеются три панели, показывающие последние полученные показания датчиков и  три графика, отражающие динамику изменения показаний.

Также имеются следующие панели по управлению системой:
- панель управления периодом обновления показаний, по истечению которого текущие показания датчиков публикуются на брокер;
- панель управления нагревателем, через которую можно изменить режим работы устройства и изменить требуемое значение температуры, которое необходимо поддерживать системой в автоматическом режиме.
- панель управления увлажнителем.
